{{- /*
WARNING: This auto-generated signing key is a WORKAROUND for development/testing only!

For PRODUCTION deployments, the signing key MUST be mounted from HashiCorp Vault
or equivalent secret management system. Storing cryptographic signing keys as
Kubernetes secrets does not meet production security requirements.

See the README.md "Production Secret Management with Vault" section for details.
*/ -}}

{{- $existingSigningKeySecret := lookup "v1" "Secret" .Release.Namespace .Values.keyService.signingKey.secretName }}
{{- if and (not .Values.keyService.signingKey.existingSecret) (not $existingSigningKeySecret) }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.keyService.signingKey.secretName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "key-service.labels" . | nindent 4 }}
  annotations:
    helm.sh/resource-policy: keep
    # WARNING: Development/test only - use Vault for production!
type: Opaque
data:
  key: {{ randAlphaNum 64 | b64enc }}
{{- end }}

---
{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace (printf "%s-secret" (include "key-service.fullname" .)) }}
{{- if not $existingSecret }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "key-service.fullname" . }}-secret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "key-service.labels" . | nindent 4 }}
  annotations:
    helm.sh/resource-policy: keep
type: Opaque
immutable: true
data:
  pbkdf2-iterations: {{ default (randInt 100000 300000 | toString | b64enc) (.Values.keyService.pbkdf2Iterations | toString | b64enc) }}
  {{- if .Values.keyService.requestEncryption.enabled }}
  {{- if .Values.keyService.requestEncryption.sharedSecret }}
  request-encryption-shared-secret: {{ .Values.keyService.requestEncryption.sharedSecret | b64enc }}
  {{- else }}
  request-encryption-shared-secret: {{ randAlphaNum 64 | b64enc }}
  {{- end }}
  {{- end }}
{{- end }}

